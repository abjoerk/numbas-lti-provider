{% load staticfiles %}
{% load i18n %}
<!doctype html>
<html>
<head>
<style type="text/css">
    body {
        margin: 0;
    }
    #scorm-player {
        border: none;
    }

    #status-display {
        position: absolute;
        bottom: 0;
        right: 0;
        padding: 0.4em 1em;
        border-radius: 4px 0 0 0;
        background: hsl(0,90%,50%);
        color: white;
        font-family: sans-serif;
        transition: background-color 0.5s;
    }
    #status-display:focus {
        border-radius: 0;
    }
    #status-display.ok {
        display: none;
    }
    #status-display .status-message {
        display: none;
    }
    #status-display:not(.localstorage-used) .text-localstorage-used {
        display: none;
    }
    #status-display:not(:focus) .status-message .text {
        display: none;
    }
    #status-display:hover:not(:focus) {
        background-color: hsl(10,90%,50%);
        cursor: pointer;
    }
    #status-display:hover:not(:focus) .symbol {
        animation: wobble 0.3s infinite linear;
        display: block;
    }
    @keyframes wobble {
        0% {
            transform: rotate(0deg);
        }
        25% {
            transform: rotate(20deg);
        }
        75% {
            transform: rotate(-20deg);
        }
        100% {
            transform: rotate(0deg);
        }
    }
    #status-display:focus .symbol {
        display: none;
    }
    #status-display.disconnected .text-disconnected {
        display: block;
    }
</style>
</head>
<body>
<iframe id="scorm-player" width="100%" height="100%" src="{{attempt.exam.extracted_url}}/index.html"></iframe>
<div id="status-display" tabindex="1" class="ok">
    <span class="symbol">!</span>
    <span class="status-message text-disconnected">
        <div class="text">
            <p>{% trans "There is currently no connection to the server - your attempt data can not be saved to the database." %}</p>
            <p>{% trans "When the connection is restored, data will be saved to the database." %}</p>
            <p class="text-localstorage-used">{% trans "Data is being saved locally, so it's safe to close the window now; you'll be able to resume this attempt from the same device when the connection is restored." %}</p>
        </div>
    </span>
</div>

{% if scorm_cmi %}
<script>
/*! modernizr 3.3.1 (Custom Build) | MIT *
 * https://modernizr.com/download/?-websockets-setclasses !*/
!function(e,n,s){function o(e,n){return typeof e===n}function a(){var e,n,s,a,t,l,c;for(var r in f)if(f.hasOwnProperty(r)){if(e=[],n=f[r],n.name&&(e.push(n.name.toLowerCase()),n.options&&n.options.aliases&&n.options.aliases.length))for(s=0;s<n.options.aliases.length;s++)e.push(n.options.aliases[s].toLowerCase());for(a=o(n.fn,"function")?n.fn():n.fn,t=0;t<e.length;t++)l=e[t],c=l.split("."),1===c.length?Modernizr[c[0]]=a:(!Modernizr[c[0]]||Modernizr[c[0]]instanceof Boolean||(Modernizr[c[0]]=new Boolean(Modernizr[c[0]])),Modernizr[c[0]][c[1]]=a),i.push((a?"":"no-")+c.join("-"))}}function t(e){var n=c.className,s=Modernizr._config.classPrefix||"";if(r&&(n=n.baseVal),Modernizr._config.enableJSClass){var o=new RegExp("(^|\\s)"+s+"no-js(\\s|$)");n=n.replace(o,"$1"+s+"js$2")}Modernizr._config.enableClasses&&(n+=" "+s+e.join(" "+s),r?c.className.baseVal=n:c.className=n)}var i=[],f=[],l={_version:"3.3.1",_config:{classPrefix:"",enableClasses:!0,enableJSClass:!0,usePrefixes:!0},_q:[],on:function(e,n){var s=this;setTimeout(function(){n(s[e])},0)},addTest:function(e,n,s){f.push({name:e,fn:n,options:s})},addAsyncTest:function(e){f.push({name:null,fn:e})}},Modernizr=function(){};Modernizr.prototype=l,Modernizr=new Modernizr;var c=n.documentElement,r="svg"===c.nodeName.toLowerCase(),u=!1;try{u="WebSocket"in e&&2===e.WebSocket.CLOSING}catch(d){}Modernizr.addTest("websockets",u),a(),t(i),delete l.addTest,delete l.addAsyncTest;for(var p=0;p<Modernizr._q.length;p++)Modernizr._q[p]();e.Modernizr=Modernizr}(window,document);

if(!Modernizr.websockets) {
    window.location = '/no-websockets';
}
</script>
<script type="text/javascript" src="{% static 'robust-websocket.js' %}"></script>
<script type="text/javascript" src="{% static 'promise.min.js' %}"></script>
<script type="text/javascript" src="{% static 'fetch.js' %}"></script>
<script type="text/javascript" src="{% static 'api.js' %}"></script>
<script type="text/javascript">
    try {
        var cmi = {{scorm_cmi|safe}};
        var attempt_pk = {{attempt.pk}};
        var fallback_url = '{% url 'attempt_scorm_data_fallback' attempt.pk %}';
        var sc = new SCORM_API(cmi,attempt_pk,fallback_url);
        window.API_1484_11 = sc.API_1484_11;
    } catch(e) {
        alert("{% trans "A connection to the server could not be created. Please report this." %}");
        console.error(e.stack);
        window.location.href = '{% url 'show_attempts' %}';
    }
</script>
{% endif %}

<script type="text/javascript">
	window.addEventListener('load',function() {
		var iframe = document.getElementById('scorm-player');

		function resize_iframe() {
			if(!iframe.contentWindow) {
				return;
			}
			try {
				var dh = document.documentElement.getBoundingClientRect().bottom;
				var ih = iframe.clientHeight;
				var oh = dh-ih;
				var wh = window.innerHeight;
				var h = wh-oh-10;
				var height = Math.max(500,h);
				iframe.style.height = height+'px';
			} catch(e) {
			}
		}
		setInterval(resize_iframe,500);
	});
</script>
</body>
</html>
